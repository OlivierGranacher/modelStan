---
title: modelStan Simulation

date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document
    theme: cerulean
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup , warning=FALSE, message=FALSE, include=FALSE, echo=T, tidy='styler'}
knitr::opts_chunk$set(echo = T, include = T, eval = T, message = F, warning = F, fig.asp = 0.4, fig.path = 'Figs/')
  library(rethinking)
  library(rstan)
  library(data.table)
  library(modelStan)
  library(ggplot2)
  library(magrittr)
  
  #devtools::install_github("rmcelreath/rethinking", ref = "Experimental")
  options(mc.cores = parallel::detectCores())
  rstan::rstan_options(auto_write = TRUE)
  pal_disc_qual <- 'harmonic' # discrete palette from colorspace qualitative
  scaleCustom <- colorspace::scale_fill_discrete_qualitative(palette = pal_disc_qual,
                                                             aesthetics = c('color', 'fill'),
                                                             name = "")
  theme_set(theme_minimal())
```


```{r data load}
  simDT <- modelStan::simPotData()
  # id for group for each pot
  #id_grp <- str(simDT[, .(id_grp = as.integer(G[1])), by = .(id_pot = as.integer(C))][, id_grp])
  
  d <- tidybayes::compose_data(simDT[, j =  !c("dat")],
                          GC = tidybayes::x_at_y(G, C),
                          BC = tidybayes::x_at_y(B, C),
                          .n_name = tidybayes::n_prefix("N")
  )
  d$S <- 1  # red sd for pot effect 
```


Modele Stan base centered

```{r mod.0}
  mod.0 <- rstan::stan(file = "simPotData_0.stan",
                       data = d,
                       chains = 4,
                       iter = 2000)
 precis(mod.0, 2)
 modelStan::plotStanParam(mod.0, "alpha_top")
 
 modelStan::addStanPred(mod.0, data = simDT, "Y_sim") %>% 
   ggplot(aes(x = C))+ 
   geom_point(aes(y = Y)) +
   geom_pointrange(aes(y = pred, ymin = q10, ymax = q90), color ="red", shape = 21, fill = NA) +
   stat_summary(aes(y = Y),fun.y = mean, geom = "point", color = "black", size = 3)
```

Modele Stan base non-centered

```{r mod.0}
  mod.0nc <- rstan::stan(file = "simPotData_0nc.stan",
                       data = d,
                       chains = 4,
                       iter = 2000)
 precis(mod.0nc, 2)
 modelStan::plotStanParam(mod.0nc, "alpha_top")
```
